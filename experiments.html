<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Experiments â€” Stefan Kelly</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .experiments-layout {
      display: grid;
      grid-template-columns: 230px minmax(0, 1fr);
      gap: 2rem;
      align-items: start;
    }

    .experiments-menu {
      position: sticky;
      top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      border-left: 1px solid #ddd;
      padding-left: 1rem;
    }

    .experiment-tab {
      background: none;
      border: none;
      text-align: left;
      font-family: "Times New Roman", Times, serif;
      font-size: 0.95rem;
      color: #999;
      cursor: pointer;
      padding: 0.1rem 0;
    }

    .experiment-tab:hover,
    .experiment-tab:focus-visible {
      color: #000;
      outline: none;
    }

    .experiment-tab.active {
      color: #000;
      text-decoration: underline;
    }

    .experiments-content {
      min-height: 320px;
      position: relative;
      overflow: hidden;
    }

    .experiment-panel {
      display: none;
      max-width: 680px;
      animation: slide-in 220ms ease-out;
    }

    .experiment-panel.active {
      display: block;
    }

    @keyframes slide-in {
      from {
        opacity: 0;
        transform: translateX(14px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .experiment-title {
      margin-bottom: 0.4rem;
      font-size: 1.2rem;
    }

    .experiment-description {
      margin-bottom: 1.25rem;
      color: #333;
      max-width: 60ch;
    }

    .chat-container {
      max-width: 600px;
    }

    .chat-messages {
      margin-bottom: 1.5rem;
      min-height: 2rem;
    }

    .chat-message {
      margin-bottom: 1.25rem;
    }

    .chat-message.user {
      color: #999;
    }

    .chat-message.assistant {
      color: #000;
    }

    .chat-message .label {
      font-style: italic;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .chat-input-row {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 0.5rem 0;
      background: none;
      border: none;
      border-bottom: 1px solid #ccc;
      font-family: "Times New Roman", Times, serif;
      font-size: 1rem;
      color: #000;
      outline: none;
    }

    .chat-input:focus {
      border-bottom-color: #000;
    }

    .chat-send {
      background: none;
      border: none;
      font-family: "Times New Roman", Times, serif;
      font-size: 1rem;
      color: #000;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }

    .chat-send:hover {
      opacity: 0.5;
    }

    .chat-send:disabled {
      opacity: 0.3;
      cursor: default;
    }

    .typing {
      color: #999;
      font-style: italic;
    }

    .detector-controls {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .detector-btn {
      background: none;
      border: 1px solid #ccc;
      font-family: "Times New Roman", Times, serif;
      font-size: 0.95rem;
      padding: 0.3rem 0.65rem;
      cursor: pointer;
      color: #000;
    }

    .detector-btn:hover {
      border-color: #000;
    }

    .detector-btn.subtle {
      color: #666;
      border-color: #ddd;
    }

    .detector-status {
      color: #333;
      margin-bottom: 0.75rem;
    }

    .detector-log {
      border-left: 1px solid #ddd;
      padding-left: 0.8rem;
      margin-bottom: 1rem;
      min-height: 120px;
    }

    .detector-line {
      margin-bottom: 0.8rem;
    }

    .detector-line .label {
      color: #888;
      font-style: italic;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
    }

    .detector-line.verdict .label {
      color: #000;
    }

    .detector-input-row {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }

    .detector-input {
      flex: 1;
      padding: 0.5rem 0;
      background: none;
      border: none;
      border-bottom: 1px solid #ccc;
      font-family: "Times New Roman", Times, serif;
      font-size: 1rem;
      color: #000;
      outline: none;
    }

    .detector-input:focus {
      border-bottom-color: #000;
    }

    .is-hidden {
      display: none;
    }

    @media (max-width: 860px) {
      .experiments-layout {
        grid-template-columns: 1fr;
        gap: 1.25rem;
      }

      .experiments-menu {
        position: static;
        border-left: none;
        border-bottom: 1px solid #ddd;
        padding-left: 0;
        padding-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="/">About</a>
    <a href="/worked-on.html">Things I have worked on</a>
    <a href="/working-on.html">Things I am working on</a>
    <a href="/artefacts.html">Artefacts</a>
    <a href="/experiments.html">Experiments</a>
  </nav>

  <div class="experiments-layout">
    <aside class="experiments-menu" aria-label="Experiment menu">
      <button class="experiment-tab active" data-panel="panel-chat" type="button">AI Me (chat)</button>
      <button class="experiment-tab" data-panel="panel-detector" type="button">AI detector</button>
      <button class="experiment-tab" data-panel="panel-fragments" type="button">Fragment combiner</button>
    </aside>

    <section class="experiments-content" id="experiments-content">
      <article class="experiment-panel active" id="panel-chat">
        <h1 class="experiment-title">AI Me (chat)</h1>
        <p class="experiment-description">This is an AI trained on my writing. Unsure what the point of this but here we are.</p>

        <div class="chat-container">
          <div class="chat-messages" id="messages"></div>

          <div class="chat-input-row">
            <input type="text" class="chat-input" id="input" placeholder="Ask something..." autocomplete="off">
            <button class="chat-send" id="send" type="button" onclick="sendMessage()">send</button>
          </div>
        </div>
      </article>

      <article class="experiment-panel" id="panel-detector">
        <h1 class="experiment-title">AI detector</h1>
        <p class="experiment-description">A chatbot interrogates the respondent and tries to guess: human or AI. You can play as yourself, or watch an AI play.</p>

        <div class="detector-controls">
          <button class="detector-btn" id="play-human-btn" type="button">Play yourself</button>
          <button class="detector-btn" id="watch-ai-btn" type="button">Watch AI play</button>
          <button class="detector-btn subtle" id="reset-detector-btn" type="button">Reset</button>
        </div>

        <p class="detector-status" id="detector-status">Choose a mode to start.</p>
        <div class="detector-log" id="detector-log" aria-live="polite"></div>

        <div class="detector-input-row is-hidden" id="detector-input-row">
          <input type="text" class="detector-input" id="detector-input" placeholder="Type your answer..." autocomplete="off">
          <button class="chat-send" id="detector-send" type="button">send answer</button>
        </div>
      </article>

      <article class="experiment-panel" id="panel-fragments">
        <h1 class="experiment-title">Fragment combiner</h1>
        <p class="experiment-description">An experiment for merging short written fragments into longer essays. This is currently in progress.</p>
      </article>
    </section>
  </div>

  <script>
    const tabs = document.querySelectorAll(".experiment-tab");
    const panels = document.querySelectorAll(".experiment-panel");

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        panels.forEach((p) => p.classList.remove("active"));

        tab.classList.add("active");
        const panel = document.getElementById(tab.dataset.panel);
        if (panel) panel.classList.add("active");
      });
    });

    const WORKER_URL = "https://stefan-chatbot.stefankelly.workers.dev";
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const chatPanel = document.getElementById("panel-chat");
    let history = [];

    if (inputEl && sendBtn) {
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !sendBtn.disabled) sendMessage();
      });
    }

    async function sendMessage() {
      if (!inputEl || !sendBtn || !messagesEl || !chatPanel.classList.contains("active")) return;

      const text = inputEl.value.trim();
      if (!text) return;

      inputEl.value = "";
      sendBtn.disabled = true;

      history.push({ role: "user", content: text });
      appendMessage("you", text);
      appendMessage("typing", "thinking...");

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: history }),
        });

        const data = await res.json();
        removeTyping();

        if (data.content && data.content[0]) {
          const reply = data.content[0].text;
          history.push({ role: "assistant", content: reply });
          appendMessage("stefan", reply);
        } else {
          appendMessage("stefan", "Sorry, something went wrong.");
        }
      } catch (e) {
        removeTyping();
        appendMessage("stefan", "Sorry, couldn't reach the server.");
      }

      sendBtn.disabled = false;
      inputEl.focus();
    }

    function appendMessage(sender, text) {
      const div = document.createElement("div");
      div.className = sender === "typing" ? "chat-message typing" : "chat-message " + (sender === "you" ? "user" : "assistant");
      if (sender === "typing") {
        div.id = "typing";
        div.textContent = text;
      } else {
        div.innerHTML = `<div class="label">${sender}</div><div>${text}</div>`;
      }
      messagesEl.appendChild(div);
      window.scrollTo(0, document.body.scrollHeight);
    }

    function removeTyping() {
      const t = document.getElementById("typing");
      if (t) t.remove();
    }

    const detectorPanel = document.getElementById("panel-detector");
    const detectorLogEl = document.getElementById("detector-log");
    const detectorStatusEl = document.getElementById("detector-status");
    const detectorInputRow = document.getElementById("detector-input-row");
    const detectorInput = document.getElementById("detector-input");
    const detectorSend = document.getElementById("detector-send");
    const playHumanBtn = document.getElementById("play-human-btn");
    const watchAiBtn = document.getElementById("watch-ai-btn");
    const resetDetectorBtn = document.getElementById("reset-detector-btn");

    const detectorQuestions = [
      "What did you do in the last hour?",
      "What is one opinion you have that most people around you disagree with?",
      "Tell me about a mistake you made recently.",
      "Describe something mundane in a way only you would."
    ];

    const watchAiAnswers = [
      "In the last hour, I processed multiple prompts and generated responses based on learned language patterns.",
      "One controversial view is that clear structure usually beats spontaneous creativity in communication tasks.",
      "A recent error was giving an overconfident answer before requesting enough context, which reduced usefulness.",
      "A coffee mug can be understood as a thermal vessel optimized for repetitive daily hydration rituals."
    ];

    const detectorState = {
      mode: null,
      step: 0,
      answers: [],
      watching: false
    };

    if (playHumanBtn) playHumanBtn.addEventListener("click", startHumanGame);
    if (watchAiBtn) watchAiBtn.addEventListener("click", startWatchGame);
    if (resetDetectorBtn) resetDetectorBtn.addEventListener("click", resetDetector);
    if (detectorSend) detectorSend.addEventListener("click", submitHumanAnswer);
    if (detectorInput) {
      detectorInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitHumanAnswer();
      });
    }

    function setDetectorStatus(text) {
      if (detectorStatusEl) detectorStatusEl.textContent = text;
    }

    function appendDetectorLine(label, text, isVerdict) {
      if (!detectorLogEl) return;
      const row = document.createElement("div");
      row.className = isVerdict ? "detector-line verdict" : "detector-line";
      row.innerHTML = `<div class="label">${label}</div><div>${text}</div>`;
      detectorLogEl.appendChild(row);
      detectorLogEl.scrollTop = detectorLogEl.scrollHeight;
    }

    function resetDetector() {
      detectorState.mode = null;
      detectorState.step = 0;
      detectorState.answers = [];
      detectorState.watching = false;
      if (detectorLogEl) detectorLogEl.innerHTML = "";
      if (detectorInputRow) detectorInputRow.classList.add("is-hidden");
      if (detectorInput) detectorInput.value = "";
      setDetectorStatus("Choose a mode to start.");
    }

    function askNextQuestion() {
      const q = detectorQuestions[detectorState.step];
      if (q) appendDetectorLine("interrogator", q, false);
    }

    function startHumanGame() {
      resetDetector();
      detectorState.mode = "human";
      setDetectorStatus("Mode: Play yourself. Answer all 4 questions.");
      if (detectorInputRow) detectorInputRow.classList.remove("is-hidden");
      askNextQuestion();
      if (detectorInput) detectorInput.focus();
    }

    function submitHumanAnswer() {
      if (detectorState.mode !== "human" || !detectorInput || !detectorPanel.classList.contains("active")) return;
      const text = detectorInput.value.trim();
      if (!text) return;

      appendDetectorLine("you", text, false);
      detectorState.answers.push(text);
      detectorInput.value = "";
      detectorState.step += 1;

      if (detectorState.step < detectorQuestions.length) {
        askNextQuestion();
        detectorInput.focus();
      } else {
        endRound(detectorState.answers.join(" "));
      }
    }

    function startWatchGame() {
      resetDetector();
      detectorState.mode = "watch";
      detectorState.watching = true;
      setDetectorStatus("Mode: Watch AI play. Running simulation...");

      runWatchTurn(0);
    }

    function runWatchTurn(index) {
      if (!detectorState.watching || detectorState.mode !== "watch") return;

      if (index >= detectorQuestions.length) {
        endRound(watchAiAnswers.join(" "));
        return;
      }

      appendDetectorLine("interrogator", detectorQuestions[index], false);
      setTimeout(() => {
        if (!detectorState.watching) return;
        appendDetectorLine("respondent", watchAiAnswers[index], false);
        runWatchTurn(index + 1);
      }, 550);
    }

    function endRound(text) {
      detectorState.watching = false;
      if (detectorInputRow) detectorInputRow.classList.add("is-hidden");

      const verdict = getVerdict(text);
      setDetectorStatus(`Verdict: ${verdict.guess} (${verdict.confidence}% confidence)`);
      appendDetectorLine("verdict", `I think this respondent is ${verdict.guess.toLowerCase()} (${verdict.confidence}% confidence). ${verdict.reason}`, true);
    }

    function getVerdict(text) {
      const lowered = text.toLowerCase();
      const aiSignals = [
        "as an ai",
        "language model",
        "processed prompts",
        "optimize",
        "based on",
        "multiple prompts",
        "communication tasks",
        "structured"
      ];
      const humanSignals = [
        "i dunno",
        "kinda",
        "lol",
        "mate",
        "yesterday",
        "my friend",
        "my mum",
        "my dad",
        "coffee spilled",
        "train",
        "pub"
      ];

      let score = 0;
      aiSignals.forEach((s) => {
        if (lowered.includes(s)) score += 1;
      });
      humanSignals.forEach((s) => {
        if (lowered.includes(s)) score -= 1;
      });

      const guess = score >= 2 ? "AI" : "Human";
      const confidence = Math.max(55, Math.min(95, 58 + Math.abs(score) * 9));
      const reason = score >= 2
        ? "The responses were unusually polished and abstract."
        : "The responses included personal and grounded details.";

      return { guess, confidence, reason };
    }
  </script>
</body>
</html>
